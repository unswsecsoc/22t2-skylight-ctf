# To build the application for tomcat
FROM ubuntu AS appbuilder

RUN apt-get update -y
RUN apt-get upgrade -y
RUN apt-get install -y maven
COPY step4/app /app
RUN cd /app && mvn install

FROM tomcat:8.0.36-jre8

# `apt-get update` will fail because this image is sooooo old
RUN dpkg --add-architecture i386
RUN apt-get update -y || true
RUN apt-get upgrade -y
RUN apt-get install -y cron file git libc6:i386 libstdc++6:i386 net-tools \
	netcat openssh-server python3 vim xinetd

RUN useradd step1
RUN useradd step2
RUN useradd step3
RUN useradd step4

# /ctf/step1
RUN mkdir -p /ctf/step1/
COPY step1/vuln /ctf/step1/
COPY step1/step1.xinited /etc/xinetd.d/step1

# /ctf/step2
COPY step2/NTDS.zip /ctf/step2/
COPY step2/README.md /ctf/step2/
RUN chown -R root:step2 /ctf/step2
RUN chmod -R 640 /ctf/step2/*
RUN chmod 750 /ctf/step2

COPY step2/users2add.txt /ctf/
RUN while read u ; do useradd "$u" -G step1,step2,step3 ; done < /ctf/users2add.txt
RUN rm -f /ctf/users2add.txt

COPY step3/sshd_config /etc/ssh/sshd_config
RUN mkdir -p /ctf/step3
COPY step3/README.md /ctf/step3/
COPY step4/source.zip /ctf/step3/source.zip
RUN chown -R root:step3 /ctf/step3
RUN chmod -R 640 /ctf/step3/*
RUN chmod 750 /ctf/step3

# The /ctf/flag.txt can only be read by users in the "step4" group
COPY flag.txt /ctf/flag.txt
RUN chown root:step4 /ctf/flag.txt
RUN chmod 640 /ctf/flag.txt

# Change password of just this user, everyone else has no password
RUN echo 'PERRY_MENDEZ:soccer15' | chpasswd

# Make directories writeable but not listable by non-root users
RUN chmod 1773 /tmp /dev/shm /dev/mqueue /run/lock /var/tmp

RUN rm -rf /usr/local/tomcat/webapps/*
COPY step4/ROOT webapps/ROOT
COPY --from=appbuilder app/target/app-1.0.war webapps/app.war

# Low priv boi. No idea what any of this crap does
RUN useradd tomcat -G step1,step2,step3,step4 && \
	touch /usr/local/tomcat/logs/catalina.out && \
	chown root:tomcat /usr/local/tomcat/logs/catalina.out && \
	chmod 660 /usr/local/tomcat/logs/catalina.out && \
	chown -R root:tomcat conf/* && \
	chmod 644 conf/* && \
	chown -R root:tomcat work && \
	chmod 775 work

# For step1 binary exploit
EXPOSE 5555

# For sshd
EXPOSE 5556

COPY scripts/cleanup_cron /etc/cron.d/cleanup_cro
COPY scripts/cleanup.sh /root/
COPY scripts/entrypoint.sh /root/
CMD ["/root/entrypoint.sh"]
